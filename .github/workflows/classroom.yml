name: GitHub Classroom Workflow (No Late Penalty + Quarto Render)

on:
  push:
  workflow_dispatch:

jobs:
  autograding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout student repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect week
        id: cfg
        run: |
          python3 tools/detect_week.py

      - name: Prepare active tests (copy from tests_bank)
        run: |
          set -euo pipefail
          WEEK="${{ steps.cfg.outputs.week }}"

          # Prevent students from adding their own *_test.py files
          EXTRA="$(find . -name '*_test.py' -not -path './__active_tests__/*' -print | head -n 1 || true)"
          if [ -n "$EXTRA" ]; then
            echo "Found unexpected test file: $EXTRA"
            echo "Please do not add *_test.py files. Put your work in submissions/$WEEK/answers.py."
            exit 1
          fi

          rm -rf __active_tests__
          mkdir -p __active_tests__

          if [ ! -f "tests_bank/$WEEK/quiz_tests.py" ]; then
            echo "Missing tests_bank/$WEEK/quiz_tests.py"
            exit 1
          fi

          cp "tests_bank/$WEEK/quiz_tests.py" "__active_tests__/quiz_test.py"

      - name: Python autograding (pytest)
        id: python-test
        uses: classroom-resources/autograding-python-grader@v1
        with:
          timeout: "15"
          max-score: "${{ steps.cfg.outputs.max_score }}"
          setup-command: |
            python -m pip install -U pip
            pip install -r requirements.txt

      - name: Report to GitHub Classroom
        uses: classroom-resources/autograding-grading-reporter@v1
        env:
          PYTHON-TEST_RESULTS: ${{ steps.python-test.outputs.result }}
        with:
          runners: python-test

      # -----------------------
      # Quarto auto-render step
      # -----------------------
      - name: Install Quarto
        if: always()
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Render Quarto report(s)
        if: always()
        continue-on-error: true
        run: |
          set -euo pipefail
          WEEK="${{ steps.cfg.outputs.week }}"

          # Ensure python deps for executing python chunks in Quarto
          python -m pip install -U pip
          pip install -r requirements.txt

          # Render student-friendly report (single source of truth: answers.py)
          quarto render
          

      - name: Upload Quarto HTML as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "quarto-${{ steps.cfg.outputs.week }}"
          if-no-files-found: ignore
          path: |
            submissions/${{ steps.cfg.outputs.week }}/laporan.html
            submissions/${{ steps.cfg.outputs.week }}/laporan_files/**
            weeks/${{ steps.cfg.outputs.week }}/quiz.html
            weeks/${{ steps.cfg.outputs.week }}/quiz_files/**
